# VC++ Redistributables Manager

Небольшое WPF-приложение для автоматизированной установки, обновления и очистки пакетов Microsoft Visual C++ Redistributable через Windows Package Manager (`winget`).

![GUI Screenshot](VC++/docs/gui.png)

## Особенности
- Установка комплекта VC++ (2005–2022) через `winget`.
- Обновление установленных VC++ через `winget`.
- Очистка старых/неиспользуемых redistributable через `winget` (попытка в `--scope user`, пропуск пакетов, требующих elevation).
- Консольное логирование в UI `LogBox` с фильтрацией анимации и ограничением размера лога (уменьшает потребление ОЗУ).
- Нет прямых вызовов WMI/`System.Management` — все операции через `winget`.

## Требования
- Windows 10/11 с установленным Windows Package Manager (`winget`) версии, совместимой с командами `install`, `uninstall`, `upgrade`.
- .NET 8 SDK (target `net8.0-windows`).
- Visual Studio 2022/2023 или `dotnet` CLI.

## Быстрый старт (разработка)
1. Клонировать репозиторий:
   - `git clone https://github.com/AlekseyFomichenko/VC-`
2. Открыть решение в Visual Studio или из папки проекта:
   - `dotnet build`
   - `dotnet publish VC++/VC++.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true  /p:IncludeNativeLibrariesForSelfExtract=true`
   - Результат будет в `VC++/bin/Release/net8.0-windows/win-x64/publish/`.
   - Запустить `VC++.exe` от имени администратора.

> В проекте включён `Nullable` (C# 12 / .NET 8). Код использует `RunWingetAsync(...)` для взаимодействия с `winget`.

## Как пользоваться
- Кнопка `Clean` — пытается удалить известные Redistributable:
  - Сначала пробует `winget uninstall --scope user` (чтобы избежать UAC для пользовательских установок).
  - Если пакет установлен в машинной области (machine), удаление требует прав администратора и будет пропущено (лог об этом появится).
  - Для пакетов с несколькими установленными версиями попытка выполняется с `--all-versions` (но всё равно может потребоваться elevation).
- Кнопка `Install` — пытается сначала установить в `--scope user`, затем (если безопасно) в системную область.
- Кнопка `Update` — пытается обновить в `--scope user` и пропускает пакеты, требующие elevation.

## Логи и диагностика
- Основной вывод виден в `LogBox` в UI. UI лог ограничен (по умолчанию ~150 KB), чтобы не расти по памяти.
- Для детальной диагностики ошибок (например, MSI exit code 1603):
  - Запустите проблемную команду `winget` вручную в PowerShell/терминале, чтобы получить полный вывод.
  - Для MSI-инсталляторов используйте лог msiexec: `msiexec /x {ProductCode} /L*V C:\temp\msilog.txt` для подробного лога установки/удаления.
- Код фильтрует анимационные/строки прогресса `winget`, чтобы лог в UI был компактным — полный вывод всё ещё доступен при запуске `winget` вручную.

## Почему появляется exit code 1603 и как действовать
Exit code `1603` — общий код ошибки MSI. Частые причины:
- Файлы/процессы блокируют установщик.
- Недостаточно прав для удаления в `machine` scope.
- Повреждённый установщик или конфликт версий.

Рекомендации:
- Проверить, установлен ли пакет в `machine` scope — такие пакеты требуют elevation.
- Попробовать удалить вручную через `Programs and Features` или запустить `winget` с повышенными правами.
- Включить MSI-лог (`/L*V`) для детального разбора проблемы.

## Про снижение потребления памяти (что сделано)
- Вывод `winget` читается построчно и в UI попадают только осмысленные строки (анимация удаляется).
- В UI хранится ограниченное количество текста (обрезка старого лога), чтобы `LogBox` не рос без контроля.
- Убрано использование WMI и больших временных буферов вывода.

Если нужно ещё снизить использование памяти — можно:
- переводить UI-лог в виртуализованный `ListBox`/`ItemsControl` с ограничением числа элементов;
- сохранять полные логи в файл вместо хранения в памяти.